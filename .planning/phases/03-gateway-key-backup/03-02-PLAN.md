---
phase: 03-gateway-key-backup
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [
  "scripts/gateway-recovery.sh",
  "scripts/test-gateway-recovery.sh"
]
autonomous: false

must_haves:
  truths:
    - "Gateways can restart with recovered encryption keys using -encryptionKeySource"
    - "Multiple gateway recovery coordinated without cross-contamination"
    - "Complete gateway backup and recovery cycle validated by testing"
  artifacts:
    - path: "scripts/gateway-recovery.sh"
      provides: "Gateway restart with recovered keys"
      min_lines: 40
    - path: "scripts/test-gateway-recovery.sh"
      provides: "End-to-end gateway recovery validation"
      min_lines: 60
  key_links:
    - from: "scripts/gateway-recovery.sh"
      to: "gateway -encryptionKeySource"
      via: "command line parameter"
      pattern: "-encryptionKeySource hex:[0-9a-f]+"
    - from: "scripts/test-gateway-recovery.sh"
      to: "complete backup/recovery cycle"
      via: "script orchestration"
      pattern: "backup.*share.*recover.*validate"
---

<objective>
Implement gateway recovery procedures using decrypted encryption keys and validate the complete backup/recovery cycle for multiple gateway instances.

Purpose: Enable disaster recovery for gateway databases by restarting gateways with recovered encryption keys, ensuring user data accessibility after failures.
Output: Gateway recovery scripts and comprehensive testing procedures with multi-gateway coordination.
</objective>

<execution_context>
@/Users/krish/.claude/get-shit-done/workflows/execute-plan.md
@/Users/krish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/README.md
@scripts/decrypt-backup.go
@scripts/test-backup-restore.sh
@.planning/phases/03-gateway-key-backup/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create gateway recovery script with -encryptionKeySource integration</name>
  <files>scripts/gateway-recovery.sh</files>
  <action>
    Create script that recovers gateway database encryption keys and restarts gateway with recovered keys. Script should:
    - Accept gateway name, encrypted backup file, and private key path as parameters
    - Use existing decrypt-backup.go to decrypt the gateway database encryption key
    - Validate that decrypted key is exactly 32 bytes (AES-256)
    - Generate proper -encryptionKeySource hex:XXXX parameter format
    - Include gateway restart procedures using recovered encryption key
    - Support multiple gateway instances with instance-specific key recovery
    - Add validation that gateway starts successfully and can access encrypted database
    - Include error handling for decryption failures and gateway startup issues
    - Follow same patterns as existing recovery scripts but gateway-specific
    Reference decrypt-backup.go output showing gateway config format for -encryptionKeySource parameter.
  </action>
  <verify>bash scripts/gateway-recovery.sh test-gateway test-backup.hex scripts/keys/test-gateway/private_key.pem --dry-run</verify>
  <done>Script successfully decrypts gateway keys and generates proper -encryptionKeySource parameter for gateway restart</done>
</task>

<task type="auto">
  <name>Create comprehensive gateway recovery test script</name>
  <files>scripts/test-gateway-recovery.sh</files>
  <action>
    Create end-to-end test script that validates complete gateway backup and recovery cycle. Script should:
    - Generate test gateway keys using gateway-specific key generation
    - Simulate gateway backup by creating test encrypted database key
    - Test SLIP-39 share generation and reconstruction for gateway keys
    - Validate gateway recovery using decrypt-backup.go and -encryptionKeySource
    - Test multiple gateway instances to ensure no cross-contamination
    - Include cleanup procedures to remove test data
    - Provide clear success/failure reporting for each test phase
    - Follow patterns from existing test-backup-restore.sh but gateway-focused
    - Add validation that recovered keys work with gateway database access
    Should test the complete workflow: key generation -> backup -> shares -> recovery -> validation.
  </action>
  <verify>bash scripts/test-gateway-recovery.sh --dry-run</verify>
  <done>Test script validates complete gateway backup/recovery cycle including multi-gateway scenarios</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete gateway key backup and recovery system with scripts for backup, SLIP-39 shares, recovery, and testing</what-built>
  <how-to-verify>
    1. Run the test script: `cd scripts && bash test-gateway-recovery.sh`
    2. Verify it tests multiple gateway instances without cross-contamination
    3. Check that generated keys work with decrypt-backup.go tool
    4. Confirm -encryptionKeySource parameter format matches gateway requirements
    5. Verify SLIP-39 share generation creates independent shares per gateway
    6. Test that any 2 shares can recover the original gateway encryption key
    Expected: All tests pass, multiple gateway instances handled correctly, no cross-contamination between gateways
  </how-to-verify>
  <resume-signal>Type "approved" when all gateway backup/recovery tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Gateway recovery script properly integrates with -encryptionKeySource parameter
- Multiple gateway instances can be recovered independently
- Test script validates complete backup/recovery cycle
- No cross-contamination between different gateway instances
- Scripts integrate properly with existing decrypt-backup.go tool
</verification>

<success_criteria>
- Gateways can restart with recovered encryption keys using -encryptionKeySource flag
- Multiple gateway recovery coordinated without cross-contamination
- Complete gateway backup and recovery cycle validated by comprehensive testing
- Gateway recovery procedures ready for UAT deployment
- Documentation and test procedures enable operational disaster recovery
</success_criteria>

<output>
After completion, create `.planning/phases/03-gateway-key-backup/03-02-SUMMARY.md`
</output>