---
phase: 03-gateway-key-backup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "scripts/gateway-backup-encryption-key.sh",
  "scripts/generate-gateway-keys.sh",
  "scripts/gateway-slip39-shares.sh"
]
autonomous: true

must_haves:
  truths:
    - "Gateway encryption keys can be backed up via API endpoint"
    - "Each gateway instance gets independent SLIP-39 share distribution"
    - "Backup keys are generated with gateway instance identification"
  artifacts:
    - path: "scripts/gateway-backup-encryption-key.sh"
      provides: "Gateway backup API integration"
      min_lines: 50
    - path: "scripts/generate-gateway-keys.sh"
      provides: "Gateway-specific key generation"
      min_lines: 30
    - path: "scripts/gateway-slip39-shares.sh"
      provides: "Independent SLIP-39 shares per gateway"
      min_lines: 40
  key_links:
    - from: "scripts/gateway-backup-encryption-key.sh"
      to: "/admin/backup-encryption-key/"
      via: "curl POST request"
      pattern: "curl.*admin/backup-encryption-key"
    - from: "scripts/generate-gateway-keys.sh"
      to: "scripts/keys/"
      via: "file system write"
      pattern: "keys/.*gateway.*\\.pem"
---

<objective>
Implement gateway database encryption key backup and SLIP-39 share distribution, enabling independent backup of each gateway instance's encryption keys.

Purpose: Provide disaster recovery capability for gateway database encryption keys separate from network consensus secrets, ensuring user data protection across gateway failures.
Output: Scripts for gateway key backup, generation, and SLIP-39 share distribution with instance isolation.
</objective>

<execution_context>
@/Users/krish/.claude/get-shit-done/workflows/execute-plan.md
@/Users/krish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/README.md
@scripts/decrypt-backup.go
@scripts/generate-keys.sh
</context>

<tasks>

<task type="auto">
  <name>Create gateway-specific key generation script</name>
  <files>scripts/generate-gateway-keys.sh</files>
  <action>
    Create script that generates ECIES key pairs specifically for gateway database encryption key backup. Script should:
    - Accept gateway instance name as parameter (e.g., "mainnet-gateway", "uat-gateway")
    - Generate private/public key pair using secp256k1 curve via OpenSSL
    - Store keys in scripts/keys/{gateway_name}/ directory structure
    - Output compressed public key in hex format for gateway -backupEncryptionKey parameter
    - Follow same patterns as existing generate-keys.sh but with gateway-specific naming
    - Add generated private keys to .gitignore automatically
    - Include validation to prevent duplicate key generation for same gateway instance
    Use existing decrypt-backup.go comment patterns showing gateway usage for reference.
  </action>
  <verify>bash scripts/generate-gateway-keys.sh test-gateway && ls scripts/keys/test-gateway/</verify>
  <done>Script creates gateway-specific keys and outputs proper configuration format for -backupEncryptionKey parameter</done>
</task>

<task type="auto">
  <name>Create gateway backup API integration script</name>
  <files>scripts/gateway-backup-encryption-key.sh</files>
  <action>
    Create script that calls the gateway /admin/backup-encryption-key/ endpoint and manages the encrypted backup. Script should:
    - Accept gateway URL and output directory as parameters
    - Make POST request to /admin/backup-encryption-key/ endpoint
    - Save encrypted response to {output_dir}/{gateway_name}-encrypted-db-key.hex
    - Include error handling for network failures and API errors
    - Validate that response is properly encrypted hex data
    - Log backup timestamp and gateway identifier for tracking
    - Follow same error handling patterns as existing UAT backup scripts
    - Support both HTTP and HTTPS gateway endpoints
    Reference the tasks.json description showing the endpoint usage pattern.
  </action>
  <verify>bash scripts/gateway-backup-encryption-key.sh http://localhost:8080 ./test-output || echo "Expected failure without running gateway"</verify>
  <done>Script successfully calls gateway backup endpoint and saves encrypted database key with proper error handling</done>
</task>

<task type="auto">
  <name>Create gateway SLIP-39 share distribution script</name>
  <files>scripts/gateway-slip39-shares.sh</files>
  <action>
    Create script that generates independent SLIP-39 2-of-3 threshold shares for gateway encryption keys. Script should:
    - Accept gateway name and private key path as parameters
    - Generate 2-of-3 SLIP-39 mnemonic shares for the private key
    - Create separate share files: {gateway_name}-share-1.txt, {gateway_name}-share-2.txt, {gateway_name}-share-3.txt
    - Include gateway instance identifier in share metadata/comments
    - Validate that any 2 shares can reconstruct the original private key
    - Follow SLIP-39 standards compatible with Trezor Safe 3
    - Prevent cross-contamination between different gateway instances
    - Include instructions for share distribution to guardian custodians
    For UAT implementation, create placeholder that documents the production SLIP-39 procedure.
  </action>
  <verify>bash scripts/gateway-slip39-shares.sh test-gateway scripts/keys/test-gateway/private_key.pem</verify>
  <done>Script generates independent SLIP-39 shares with gateway isolation and proper validation</done>
</task>

</tasks>

<verification>
- Gateway key generation produces secp256k1 keys with proper naming
- Backup script integrates with /admin/backup-encryption-key/ API
- SLIP-39 shares are generated independently per gateway instance
- All scripts follow existing patterns in scripts/ directory
- No cross-contamination between gateway instances possible
</verification>

<success_criteria>
- Gateway-specific backup keys can be generated with instance identification
- Gateway database encryption keys can be backed up via API endpoint
- Each gateway gets independent 2-of-3 SLIP-39 share distribution
- Gateway backup process isolated from network shared secret backup
- Scripts ready for UAT testing with existing gateway infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/03-gateway-key-backup/03-01-SUMMARY.md`
</output>