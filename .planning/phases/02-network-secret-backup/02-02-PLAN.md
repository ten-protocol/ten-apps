---
phase: 02-network-secret-backup
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - scripts/uat-network-recovery.sh
  - charts/ten-backup/templates/configmap.yaml
autonomous: false

must_haves:
  truths:
    - "Network can restart successfully using shared secret reconstructed from 2 shares"
    - "Recovery process validates secret integrity before network restart"
    - "Secret reconstruction produces valid shared secret for enclave configuration"
  artifacts:
    - path: "scripts/uat-network-recovery.sh"
      provides: "Network recovery procedure using reconstructed shared secret"
      min_lines: 40
    - path: "charts/ten-backup/templates/configmap.yaml"
      provides: "Updated configmap with recovery scripts"
      contains: "uat-network-recovery.sh"
  key_links:
    - from: "scripts/uat-network-recovery.sh"
      to: "scripts/uat-simple-secret-split.go"
      via: "share combination call"
      pattern: "go run.*uat-simple-secret-split.go.*-combine"
    - from: "reconstructed secret"
      to: "enclave configuration"
      via: "sharedSecret parameter"
      pattern: "enclave.sharedSecret"
---

<objective>
Implement network recovery procedure using reconstructed shared secrets

Purpose: Complete the backup/recovery cycle by enabling network restart with shared secrets reconstructed from guardian shares
Output: Recovery procedure that validates and applies reconstructed secrets for network restart
</objective>

<execution_context>
@/Users/krish/.claude/get-shit-done/workflows/execute-plan.md
@/Users/krish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-setup/01-CONTEXT.md
@.planning/phases/02-network-secret-backup/02-01-SUMMARY.md
@scripts/uat-backup-shared-secret.sh
@scripts/test-backup-restore.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Network Recovery Script</name>
  <files>scripts/uat-network-recovery.sh</files>
  <action>
    Create UAT network recovery script that reconstructs shared secret from guardian shares:

    - Prompts for 2 of 3 shares (share-1.txt and share-2.txt OR share-1.txt and share-3.txt OR share-2.txt and share-3.txt)
    - Uses uat-simple-secret-split.go -combine to reconstruct the original shared secret
    - Validates reconstructed secret is 64 hex chars (32 bytes)
    - Optionally tests secret against validator using ten_enclave_status RPC call
    - Outputs enclave configuration format: enclave.sharedSecret: "reconstructed_hex"
    - Provides instructions for updating UAT environment configuration

    Include safety checks: verify share format, validate reconstruction success, confirm secret length. Base structure on test-backup-restore.sh patterns.
  </action>
  <verify>
    bash -n scripts/uat-network-recovery.sh # syntax check
  </verify>
  <done>
    Recovery script validates syntactically and includes share input, reconstruction, validation, and configuration output phases
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ConfigMap with Recovery Script</name>
  <files>charts/ten-backup/templates/configmap.yaml</files>
  <action>
    Add the recovery script to the backup tools ConfigMap:

    - Add uat-network-recovery.sh to the data section
    - Maintain all existing scripts from previous tasks
    - Follow existing YAML formatting and indentation patterns
    - Ensure script has proper executable permissions when mounted

    This completes the backup/recovery script set: generation, backup, splitting, and recovery.
  </action>
  <verify>
    helm template charts/ten-backup | grep -A 30 "kind: ConfigMap" | grep "uat-network-recovery.sh"
  </verify>
  <done>
    ConfigMap includes recovery script and Helm template generates valid manifests
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Complete UAT network secret backup and recovery system with simple 2-of-3 secret sharing</what-built>
  <how-to-verify>
    1. Deploy backup tools to UAT environment: kubectl apply -f nonprod-argocd-config/apps/envs/uat/backup-tools-app.yaml
    2. Connect to backup tools pod: kubectl exec -it deployment/backup-tools -n uat-backup -- /bin/bash
    3. Test complete backup cycle: cd /scripts && ./uat-backup-network-secret.sh
    4. Verify 3 share files are created: share-1.txt, share-2.txt, share-3.txt
    5. Test recovery with 2 shares: ./uat-network-recovery.sh
    6. Confirm reconstructed secret matches original from backup
    7. Verify secret format is suitable for enclave configuration
  </how-to-verify>
  <resume-signal>Type "approved" if backup/recovery cycle works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Recovery script reconstructs shared secret from any 2 of 3 guardian shares
- Reconstructed secret validates as proper 32-byte enclave shared secret
- Complete backup/recovery cycle produces consistent results
- All scripts included in backup tools container deployment
</verification>

<success_criteria>
- Network recovery procedure successfully reconstructs shared secret from 2 guardian shares
- Recovery process validates secret integrity and format before applying configuration
- Complete backup/recovery cycle demonstrates UAT network secret protection
- Guardian workflow supports practical disaster recovery operations
</success_criteria>

<output>
After completion, create `.planning/phases/02-network-secret-backup/02-02-SUMMARY.md`
</output>